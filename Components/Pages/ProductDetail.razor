@page "/product-detail/{ProductId:int}"
@using MaillotStore.Components
@using MaillotStore.Components.Sections
@using MaillotStore.Data
@using MaillotStore.Models
@using MaillotStore.Services
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject CartService CartService
@inject NavigationManager NavigationManager

<div class="product-detail-page-container">

    <HomePageSearchBar />

    @if (_product == null)
    {
        <div class="container py-5 text-center text-white">
            <p><em>Loading product details...</em></p>
        </div>
    }
    else
    {
        <div class="full-width-section product-main-container " style="margin-top: 0px;">
            <div class="container py-5">
                <div class="row">
                    <div class="col-md-6">
                        <img src="@_product.ImageUrl" alt="@_product.Name" class="img-fluid rounded mb-3" />

                        <div class="row">
                            <div class="col-4 d-flex justify-content-center">
                                <img src="@_product.ImageUrl" alt="Thumbnail 1" class="img-fluid rounded thumbnail-img" />
                            </div>
                            <div class="col-4 d-flex justify-content-center">
                                <img src="/Images/wolves.jpg" alt="Thumbnail 2" class="img-fluid rounded thumbnail-img" />
                            </div>
                            <div class="col-4 d-flex justify-content-center">
                                <img src="/Images/Liverpool.jpeg" alt="Thumbnail 3" class="img-fluid rounded thumbnail-img" />
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 text-white">
                        <h1 class="product-title fw-bold mb-3">@_product.Name</h1>
                        <p class="product-price fs-4 fw-bold mb-3">FCFA @_product.Price.ToString("N0") XAF</p>
                        <p class="product-season text-muted mb-4">@_product.Season</p>
                        <p class="mb-5">@_product.Description</p>

                        <h3 class="fw-bold mb-3">Customization Info</h3>
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Player's Name (Optional)</label>
                                <input type="text" @bind="_playerName" class="form-control" placeholder="Player's Name" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Number (Optional)</label>
                                <input type="text" @bind="_playerNumber" class="form-control" placeholder="Number" />
                            </div>
                        </div>
                        <div class="row mb-5">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Quantity</label>
                                <input type="number" @bind="_quantity" class="form-control" min="1" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Select Size</label>
                                <select class="form-select" @bind="_selectedSize">
                                    <option>S</option>
                                    <option>M</option>
                                    <option>L</option>
                                    <option>XL</option>
                                </select>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-dark btn-lg" @onclick="AddToCartAndStay">ADD TO CART</button>
                            @* FIX: The "ORDER NOW" button now calls the new OrderNow method *@
                            <button class="btn btn-primary btn-lg" @onclick="OrderNow">ORDER NOW</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="full-width-section you-may-also-like-container">
        <div class="container py-5">
            <h2 class="text-start mb-5 text-white">You May Also Like ...</h2>
            <div class="row">
                @if (_relatedProducts != null)
                {
                    @foreach (var relatedProduct in _relatedProducts)
                    {
                        <ProductCard Product="relatedProduct" />
                    }
                }
            </div>
        </div>
    </div>
</div>

<Footer />

@code {
    [Parameter]
    public int ProductId { get; set; }

    private Product _product;
    private List<Product> _relatedProducts;

    private int _quantity = 1;
    private string _playerName;
    private string _playerNumber;
    private string _selectedSize = "M";

    protected override async Task OnParametersSetAsync()
    {
        _product = await DbContext.Products.FindAsync(ProductId);
        if (_product != null)
        {
            _relatedProducts = await DbContext.Products
                .Where(p => p.Id != ProductId)
                .Take(4)
                .ToListAsync();
        }
    }

    // This method just adds to cart
    private void AddToCart()
    {
        if (_product != null)
        {
            var orderItem = new OrderItem
            {
                ProductId = _product.Id,
                Product = _product,
                Quantity = _quantity,
                Subtotal = _product.Price * _quantity,
                PlayerName = _playerName,
                PlayerNumber = _playerNumber,
                Size = _selectedSize
            };
            CartService.AddToCart(orderItem);
        }
    }

    // Renamed the old "AddToCart" to make its purpose clear
    private void AddToCartAndStay()
    {
        AddToCart();
        // Optionally, show a "Added to cart!" message here
    }

    // FIX: New method for the "ORDER NOW" button
    private void OrderNow()
    {
        // First, add the item to the cart
        AddToCart();
        // Then, immediately navigate to the checkout page
        NavigationManager.NavigateTo("/checkout");
    }
}